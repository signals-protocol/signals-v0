# 거버넌스 & 업그레이드

Signals 컨트랙트는 현재 간결한 거버넌스 모델을 따르지만, 업그레이드를 수행할 때는 엄격한 절차가 필요합니다. 이 문서는 새 바이트코드를 배포하거나 운영 권한을 넘길 때 따라야 할 체크리스트입니다.

## 1. 현재 권한 구조

`CLMSRMarketCore`, `CLMSRPosition`, `PointsGranter`는 단일 `Ownable` 오너가 제어합니다. 이 계정(EOA 또는 관리용 컨트랙트)은 시장 생성, 거래 일시정지/해제, 정산, 프록시 업그레이드를 수행합니다. 아직 타임락이나 멀티시그는 활성화되지 않았으므로 Dispatcher 스크립트, 코드 리뷰, 배포 manifest가 주요 안전장치입니다. 로드맵에는 업그레이드와 정산을 다중 승인으로 묶는 타임락 + 멀티시그 래퍼 도입이 포함되어 있습니다.

## 2. 업그레이드 준비

1. 새 구현을 개발하고 테스트합니다. 컴파일된 바이트코드에 대해 단위/통합/불변성/가스 테스트를 실행해 저장소 레이아웃 호환성을 확인하세요.
2. Hardhat Ignition 또는 제공된 `deploy` 스크립트로 구현을 배포하고 주소를 기록합니다.
3. Dispatcher 설정(`MANIFEST_DEFAULT_DIR`, 환경 파일)을 업데이트해 `yarn upgrade:<env>`가 새 빌드를 가리키도록 합니다.

## 3. 업그레이드 실행

1. Dispatcher를 실행합니다. 예:
   ```bash
yarn upgrade:citrea:prod
   ```
   이 명령은 코어/포지션/포인트 프록시에 `upgradeTo`를 호출합니다. 트랜잭션 영수증을 확인해 성공 여부를 검증하세요.
2. `scripts/verify-all.sh`로 블록 익스플로러에 소스를 검증해 감사자가 바이트코드를 확인할 수 있게 합니다.
3. `deployments/environments/*.json`에 새 구현 주소, 버전, 타임스탬프를 추가합니다. 이 manifest가 어떤 바이트코드가 라이브인지 나타내는 단일 진실 원본입니다.
4. `website/docs/changelog`에 릴리스 노트를 게시해 행동 변화와 마이그레이션 고려 사항을 요약합니다.

## 4. 롤백

업그레이드를 되돌려야 한다면 이전 구현을 다시 배포한 뒤 `upgradeTo`를 호출해 주소를 복원합니다. 저장소는 유지되지만, 이전 코드가 동일한 레이아웃을 사용한다는 점을 반드시 확인해야 합니다. manifest와 changelog에 롤백 사실을 기록하세요.

## 5. 설정 변경과 업그레이드 구분

일상적인 조정(OutcomeSpec, 유동성 파라미터 $\alpha$, 거래 시간)은 다음 시장을 만들 때 적용합니다. 현재 시장의 타임스탬프를 조정해야 한다면 `updateMarketTiming`을 사용하세요. 수수료, 다른 가격 소스, 새로운 페이아웃 로직처럼 구조적인 변경은 컨트랙트 업그레이드가 필요하므로 위 체크리스트를 모두 따라야 합니다.

## 6. 보다 강한 거버넌스를 향해

앞으로는 타임락과 멀티시그 래퍼를 추가해 업그레이드, 정산, 비상 정지를 서로 다른 팀이 공동으로 맡을 수 있도록 할 예정입니다. 새로운 레이어가 도입되면 서명자 역할, 큐/취소 흐름, 비상 절차를 별도의 가이드로 제공할 것입니다. 그때까지는 Dispatcher 스크립트, manifest, changelog를 모든 변경의 필수 산출물로 취급하세요.
