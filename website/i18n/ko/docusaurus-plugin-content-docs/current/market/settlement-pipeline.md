# 정산 파이프라인

이 문서는 시그널스가 일일 정산에서 보장하는 운영 절차를 정리합니다. 정산 동작을 감사하거나 신뢰 가정을 이해할 때 참고하세요.

## 데이터 소스와 타이밍

- **오라클 입력** – CoinMarketCap BTC/USD 일별 종가를 사용합니다. UTC 00:00–23:59 캔들이 확정되면 값을 가져옵니다.
- **제출 창** – 공식 종가가 확인되는 즉시 `settleMarket(marketId, settlementValue)` 트랜잭션을 송신합니다. 온체인 타임스탬프로 정산 시점을 검증할 수 있습니다.
- **틱 매핑** – 제출된 가격은 설정된 틱 범위로 클램프한 뒤 틱 간격으로 나누어 정산 틱을 산출합니다.

## 배치 전송

대규모 시장은 수천 개의 포지션을 포함할 수 있으므로, 가스 한도를 지키기 위해 정산 이벤트를 순차적인 배치로 전파합니다.

1. `settleMarket`는 정산 틱과 값을 기록하지만 포지션을 순회하지 않습니다.
2. 후속 작업이 `emitPositionSettledBatch(limit)`를 반복 호출해 컨트랙트가 완료 신호를 줄 때까지 실행합니다.
3. 각 배치마다 진행 상황을 저장하기 때문에 재실행해도 안전합니다.

Goldsky 서브그래프는 `PositionSettled`, `PositionEventsProgress` 이벤트를 추적해 배치가 완료되었는지 독립적으로 확인할 수 있습니다.

## 청구 규칙

- 포지션에 정산 플래그가 세트되는 즉시 청구가 가능하며 **만료 기한은 없습니다**.
- 청구 시 원래 스테이크(백서 규격에 따라 내림 라운딩 적용)가 지급되고 포지션 토큰은 소각됩니다.
- 서브그래프가 청구 상태와 미청구 금액을 반영하므로 대시보드에서 잔여 금액을 보여줄 수 있습니다.

## 운영 투명성

- `deployments/environments/` 아래 manifest가 모든 업그레이드 및 정산 관련 주소를 기록합니다.
- `verification/check-market-pnl.ts` 등 검증 스크립트가 온체인 잔액과 CLMSR 예상치를 대조합니다.
- 사건 대응: CoinMarketCap 데이터를 확보할 수 없을 경우 검증 가능한 공식 값이 나올 때까지 정산을 미루고 시장은 일시 정지 상태를 유지합니다.

트레이더 관점의 설명은 [정산 & 청구](../user/settlement.md) 문서를, 메이커 손실 한계를 보장하는 수학은 [안전 한계 & 파라미터](../mechanism/safety-parameters.md) 문서를 참고하세요.
