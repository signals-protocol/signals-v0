# 정산 파이프라인

이 문서는 시그널스 운영팀이 시장을 마감할 때 따르는 매뉴얼입니다. 공식 가격을 받아서 마지막 배치를 내보내기까지 전 과정을 설명해 감사자와 통합자가 어떤 보증을 기대할 수 있는지 명확히 합니다.

## 공식 가격 수집

시그널스는 CoinMarketCap BTC/USD 일일 종가를 사용합니다. UTC 00:00-23:59 캔들이 확정되는 순간 값을 가져오며, 피드가 지연되거나 이상해 보이면 검증 가능한 수치가 나올 때까지 시장을 일시 중지한 상태로 유지합니다. 입력이 확정되기 전에는 정산 트랜잭션을 보내지 않습니다.

## 정산 게시

가격을 확인하면 운영자가 `settleMarket(marketId, settlementValue)`를 브로드캐스트합니다. 컨트랙트는 제출된 값을 설정된 틱 범위 안으로 클램프하고, 정산 틱과 원시 값을 저장한 뒤 타임스탬프가 있는 이벤트를 발행합니다. 이 호출은 포지션을 순회하지 않고 결과만 고정해 후속 작업이 시작될 수 있도록 신호를 줍니다.

## 배치 전송

가스 사용을 제한하기 위해 정산은 결정적 배치로 진행됩니다.
1. 자동화 스크립트가 안전한 한도와 함께 `emitPositionSettledBatch(limit)`를 호출합니다.
2. 컨트랙트가 일정 구간의 포지션을 순회하며 `PositionSettled` 이벤트를 발행하고 인덱스를 전진시킵니다.
3. `PositionEventsProgress` 이벤트가 처리 구간을 기록합니다. `done = true`가 나올 때까지 반복합니다.

배치는 멱등적이라 실행이 끊겨도 다시 돌리면 중복 없이 이어집니다. Goldsky 서브그래프가 두 이벤트를 모두 인덱싱해 운영자와 감사자가 실시간 진행 상황을 확인할 수 있습니다.

## 청구 활성화

포지션이 정산 처리되는 즉시 소유자는 `claimPayout`을 호출할 수 있습니다. 청구 시 남은 스테이크와 페이아웃(클에엠에스알 규격에 따라 라운딩 적용)이 지급되고 포지션 NFT가 소각됩니다. 만료 기한은 없지만, 청구를 제때 완료하면 분석과 재무 정리가 수월합니다.

## 투명성과 모니터링

- `deployments/environments/` 아래 manifest가 정산에 쓰이는 모든 컨트랙트 주소를 보여 줍니다.
- `verification/check-market-pnl.ts` 등 검증 도구와 퍼블릭 서브그래프가 CLMSR 모델과 지급 결과를 대조합니다.
- 사건 대응 매뉴얼은 오라클 피드를 사용할 수 없거나 불일치가 감지되면 시장을 일시 중지하도록 요구하며, 검증된 종가가 확보되기 전에는 자금이 풀 밖으로 나가지 않습니다.

트레이더용 설명은 [정산 & 청구](../user/settlement.md) 문서에서, 메이커 손실 한계는 [안전 한계 & 파라미터](../mechanism/safety-parameters.md)에서 확인하세요.
