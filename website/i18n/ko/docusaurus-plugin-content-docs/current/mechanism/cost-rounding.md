# 비용 함수와 라운딩

> 참고: Signals CLMSR 백서 v1.0 — §4–§8

## 볼록 잠재함수

CLMSR은 틱 보유량 $q_b$에 대해 하나의 잠재함수만 유지합니다.

$$
C(q) = \alpha \ln \left( \sum_b e^{q_b / \alpha} \right)
$$

- $\alpha$는 시장의 유동성 파라미터이며 내부에서는 WAD(18 decimals)로 저장됩니다.
- $w_b = e^{q_b / \alpha}$는 밴드별 지수 가중치입니다.
- 가격은 기울기 $p_b = w_b / \sum_j w_j$로 계산되어 항상 합이 1입니다.

밴드 $B$의 보유량을 $\delta$만큼 매수하면 각 가중치가 $\varphi = e^{\delta / \alpha}$배가 되고 비용은 다음과 같습니다.

$$
\Delta C = \alpha \ln\left( \frac{\Sigma_{\text{after}}}{\Sigma_{\text{before}}} \right)
$$

(판매는 $\delta$ 부호만 반대로 적용합니다.)

## 안전한 청크 분할

지수 계산은 PRB-Math의 입력 제한을 넘지 않도록 청크 단위로 나눕니다. 백서는 `MAX_EXP_INPUT_WAD = 1.0e18`을 정의하여 각 청크가 `(chunk / α) ≤ 1`을 만족하도록 요구합니다. Lazy segment tree가 거래를 자동으로 분할합니다.

## 비대칭 라운딩

거래별 환산은 한 번만 수행하며 방향은 액션에 따라 고정됩니다.

| 액션 | 방향 | 사용 함수 |
| --- | --- | --- |
| 매수 / 증가 | 항상 올림 | `fromWadRoundUp` |
| 매도 / 감소 / 종료 | 항상 내림 | `fromWadFloor` |
| 정산 지급 | 항상 내림 | `fromWadFloor` |

**구현 현황:** 매수는 이미 `fromWadRoundUp`을 사용하지만, 판매와 지급은 현재 Solidity에서 아직 올림을 적용합니다. 향후 업데이트 시 백서와 동일하게 내림으로 교체될 예정이며, 그때까지는 실제 지급 금액이 표기 대비 소폭 높을 수 있음을 UI에서 안내해야 합니다.

## 최소 비용 보장

매수 시 올림과 최소 주문 `δ_min` 덕분에 모든 거래는 최소 1 마이크로 SUSD 이상을 차감합니다. 이는 백서 §8에서 언급한 “0원 포지션” 공격을 제거합니다.

## 참고 문헌

- 백서 §4 — 잠재함수와 가중치 정의.
- 백서 §5 — lazy segment tree를 통한 범위 업데이트.
- 백서 §8 — 단일 변환 규칙과 라운딩 헬퍼.
