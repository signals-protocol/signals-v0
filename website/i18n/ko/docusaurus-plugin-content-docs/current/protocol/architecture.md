# 시그널스 프로토콜 구조

겉보기에는 단순한 예측 앱처럼 보이지만, 사용자가 슬라이더를 움직일 때마다 컨트랙트·스크립트·데이터 서비스가 동시에 작동합니다. 이 문서는 온체인 코어에서 분석 레이어까지 하루 주기를 따라가며 각 구성 요소가 어떻게 동기화되는지 설명합니다.

## 1. CLMSR 코어 컨트랙트

Signals의 중심에는 CLMSR 코어(`CLMSRMarketCore.sol`)와 포지션 매니저(`CLMSRPosition.sol`)가 있습니다. 이들은 밴드 가중치를 저장하는 lazy multiplicative segment tree를 유지하고, ERC 721 포지션 토큰을 발행하며, 범위 개설·조정·종료에 필요한 엔트리포인트를 제공합니다. 단위 변환, 라운딩, 안전 한계는 모두 백서의 수학을 그대로 강제하며, `PointsGranter`와 같은 보조 모듈은 정산 자금을 건드리지 않고 참여 보상을 기록합니다. 업그레이더블 프록시는 릴리스마다 저장소 레이아웃을 안정적으로 유지합니다.

## 2. 일일 운영 파이프라인

운영 스크립트는 UTC 기준 하루에 한 번 새 시장을 만듭니다. 틱 범위와 간격, 타임스탬프, 유동성 파라미터를 제출하고, 세션 동안 불변식을 모니터링합니다. 지정된 기준 값이 검증되면 `settleMarket`을 호출하고 모든 포지션이 최종 상태로 전환됐는지 확인합니다. Dispatcher 스크립트와 배포 manifest는 수동 단계를 제거하고, 어떤 구현이 어떤 작업을 처리했는지 기록해 감사를 쉽게 합니다.

## 3. 오라클 입력과 데이터 서피스

가격 수집은 보수적으로 진행됩니다. 운영자가 지정된 기준 값을 가져와 설정된 틱 범위로 클램프한 뒤 타임스탬프와 함께 온체인에 게시합니다. Goldsky가 호스팅하는 서브그래프(`clmsr-subgraph`)는 `MarketCreated`, `Position*`, 정산 관련 상태를 모두 미러링하고 `MarketStats`, `UserPosition`, `Trade`, `PositionSettled`, `PositionClaimed` 등 엔티티를 노출합니다. `verification/` 디렉터리의 스크립트는 체인 잔액을 CLMSR 기대치와 비교해 이상을 조기에 포착합니다.

## 4. 프런트엔드와 클라이언트 애플리케이션

Signals 프런트엔드는 ethers.js로 컨트랙트를 호출하고 서브그래프에서 읽어 옵니다. `MainProvider`는 `useBTCState`, `useChart`, `usePrediction`, `useAction` 훅을 조합해 차트·범위 선택·모달이 하나의 상태를 공유하도록 구성합니다. 거래가 정산되면 UI 컴포넌트는 서브그래프 엔티티로 곧바로 갱신되고, 성공 모달은 온체인과 동일한 확률 공식을 재사용합니다. 외부 클라이언트도 이 패턴을 그대로 적용해 작성 트랜잭션은 컨트랙트로, 조회는 서브그래프로 처리할 수 있습니다.

## 5. 하루 동안 정보가 흐르는 방식

1. 사용자가 앱에서 거래를 제출하면 트랜잭션이 CLMSR 코어에 도달하고 구조화된 이벤트를 발생시킵니다.
2. 운영 스크립트가 시장 생성과 정산을 담당해 온체인 상태를 실제 스케줄과 맞춥니다.
3. 서브그래프는 거래 및 운영 이벤트를 모두 수집해 분석, 리더보드, 모니터링에 필요한 정규화된 데이터를 제공합니다.
4. 대시보드와 프런트엔드는 이 데이터를 렌더링해 흐름, 정산 상태, 포인트를 즉시 보여 줍니다.

## 6. 확장성과 로드맵

현재 스택만으로도 일일 시장이 자동으로 운영되지만, 오라클 자동화, 오너 역할에 대한 타임락/멀티시그, 최소 주문과 라운딩 규칙을 강제하는 업데이트가 준비 중입니다. 각 레이어가 느슨하게 결합되어 있어 이러한 개선을 전체 시스템을 다시 작성하지 않고도 도입할 수 있습니다.

## 참고 자료

- [메커니즘 개요](../mechanism/overview.md): CLMSR 수학과 라운딩 보장.
- [보안 및 테스트](../security/audits.md): 방어 체계, 테스트 커버리지, 향후 계획.
- [거버넌스 & 업그레이드](../governance/upgrades.md): 배포와 업그레이드를 위한 운영 체크리스트.
